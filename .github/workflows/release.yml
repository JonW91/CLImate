name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [linux-x64, linux-arm64, osx-x64, osx-arm64, win-x64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish
        run: |
          dotnet publish CLImate.App -c Release -r ${{ matrix.rid }} \
            -p:PublishSingleFile=true \
            -p:SelfContained=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o dist/${{ matrix.rid }}

      - name: Package
        run: |
          RID="${{ matrix.rid }}"
          ASSET_OS="${RID%%-*}"
          if [[ "$ASSET_OS" == "osx" ]]; then
            ASSET_OS="macos"
          fi
          BIN_NAME=climate
          EXT=tar.gz
          if [[ "$RID" == win-* ]]; then
            BIN_NAME=climate.exe
            EXT=zip
          fi

          if [[ ! -f dist/$RID/$BIN_NAME ]]; then
            echo "Missing binary for $RID" >&2
            exit 1
          fi

          mkdir -p release-assets
          if [[ "$EXT" == "zip" ]]; then
            (cd dist/$RID && zip -qr "../../release-assets/climate-${ASSET_OS}-${RID#*-}.zip" "$BIN_NAME" Assets/)
          else
            (cd dist/$RID && tar -czf "../../release-assets/climate-${ASSET_OS}-${RID#*-}.tar.gz" "$BIN_NAME" Assets/)
          fi

          # Generate checksum
          cd release-assets
          sha256sum climate-${ASSET_OS}-${RID#*-}.* > climate-${ASSET_OS}-${RID#*-}.sha256

      - name: Build DEB package (Linux x64 only)
        if: matrix.rid == 'linux-x64'
        run: |
          set -f
          VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION=$(echo "$VERSION" | sed 's/-beta/~beta/')
          PKG_DIR="climate_${PKG_VERSION}_amd64"
          PKG_DIR=$(printf '%s' "$PKG_DIR")

          mkdir -p "$PKG_DIR/DEBIAN"
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/usr/share/climate/Assets"

          cp dist/linux-x64/climate "$PKG_DIR/usr/bin/climate"
          chmod 755 "$PKG_DIR/usr/bin/climate"
          cp -r dist/linux-x64/Assets/* "$PKG_DIR/usr/share/climate/Assets/" 2>/dev/null || true

          {
            echo "Package: climate"
            echo "Version: $PKG_VERSION-1"
            echo "Section: utils"
            echo "Priority: optional"
            echo "Architecture: amd64"
            echo "Maintainer: JonW91 <jonw91@users.noreply.github.com>"
            echo "Homepage: https://github.com/JonW91/CLImate"
            echo "Description: Cross-platform CLI weather forecast with ASCII art"
            echo " CLImate is a command-line weather forecast application built with .NET 10."
            echo " Get beautiful ASCII art weather forecasts directly in your terminal."
          } > "$PKG_DIR/DEBIAN/control"

          dpkg-deb --build "$PKG_DIR"
          mv "$PKG_DIR.deb" release-assets/

      - name: Build RPM package (Linux x64 only)
        if: matrix.rid == 'linux-x64'
        run: |
          sudo apt-get update && sudo apt-get install -y rpm

          VERSION="${GITHUB_REF_NAME#v}"
          RPM_VERSION=$(echo "$VERSION" | sed 's/-beta/~beta/')

          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          # Create tarball for RPM
          mkdir -p climate-${RPM_VERSION}
          cp dist/linux-x64/climate climate-${RPM_VERSION}/
          cp -r dist/linux-x64/Assets climate-${RPM_VERSION}/ 2>/dev/null || true
          tar -czf ~/rpmbuild/SOURCES/climate-${RPM_VERSION}.tar.gz climate-${RPM_VERSION}

          # Create spec file
          cat > ~/rpmbuild/SPECS/climate.spec << EOF
          Name:           climate
          Version:        ${RPM_VERSION}
          Release:        1%{?dist}
          Summary:        Cross-platform CLI weather forecast with ASCII art
          License:        MIT
          URL:            https://github.com/JonW91/CLImate
          Source0:        climate-${RPM_VERSION}.tar.gz
          
          %description
          CLImate is a command-line weather forecast application built with .NET 10.
          Get beautiful ASCII art weather forecasts directly in your terminal.
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}%{_bindir}
          mkdir -p %{buildroot}%{_datadir}/%{name}/Assets
          install -m 755 climate %{buildroot}%{_bindir}/climate
          cp -r Assets/* %{buildroot}%{_datadir}/%{name}/Assets/ 2>/dev/null || true
          
          %files
          %{_bindir}/climate
          %{_datadir}/%{name}
          
          %changelog
          * $(date "+%a %b %d %Y") JonW91 <jonw91@users.noreply.github.com> - ${RPM_VERSION}-1
          - Release ${VERSION}
          EOF

          rpmbuild -bb ~/rpmbuild/SPECS/climate.spec
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} release-assets/ \;

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.rid }}
          path: release-assets/*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: assets
          merge-multiple: true

      - name: List assets
        run: ls -la assets/

      - name: Delete existing release if any
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete ${{ github.ref_name }} --repo ${{ github.repository }} --yes 2>/dev/null || true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: assets/*
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}

  chocolatey:
    needs: release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Download Windows release
        shell: pwsh
        run: |
          $url = "https://github.com/JonW91/CLImate/releases/download/${{ github.ref_name }}/climate-win-x64.zip"
          Invoke-WebRequest -Uri $url -OutFile climate-win-x64.zip -UseBasicParsing
          $hash = (Get-FileHash climate-win-x64.zip -Algorithm SHA256).Hash
          echo "HASH=$hash" >> $env:GITHUB_OUTPUT
        id: download

      - name: Create Chocolatey package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $hash = "${{ steps.download.outputs.HASH }}"

          New-Item -ItemType Directory -Path "choco/tools" -Force | Out-Null

          # Create nuspec
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
            <metadata>
              <id>climate</id>
              <version>$version</version>
              <title>CLImate - Terminal Weather Forecast</title>
              <authors>JonW91</authors>
              <owners>JonW91</owners>
              <projectUrl>https://github.com/JonW91/CLImate</projectUrl>
              <licenseUrl>https://github.com/JonW91/CLImate/blob/main/LICENSE</licenseUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <projectSourceUrl>https://github.com/JonW91/CLImate</projectSourceUrl>
              <docsUrl>https://github.com/JonW91/CLImate#readme</docsUrl>
              <bugTrackerUrl>https://github.com/JonW91/CLImate/issues</bugTrackerUrl>
              <tags>weather forecast cli terminal ascii-art dotnet cross-platform</tags>
              <summary>Cross-platform CLI weather forecast with beautiful ASCII art</summary>
              <description>CLImate is a cross-platform command-line weather forecast application built with .NET. Features global location search, colorful ASCII art weather displays, 7-day forecasts, today view, and hourly forecasts.</description>
              <releaseNotes>https://github.com/JonW91/CLImate/releases/tag/${{ github.ref_name }}</releaseNotes>
            </metadata>
            <files>
              <file src="tools\**" target="tools" />
            </files>
          </package>
          "@ | Set-Content "choco/climate.nuspec" -Encoding UTF8

          # Create install script
          @"
          `$ErrorActionPreference = 'Stop'
          `$packageName = 'climate'
          `$toolsDir = "`$(Split-Path -Parent `$MyInvocation.MyCommand.Definition)"
          `$url64 = 'https://github.com/JonW91/CLImate/releases/download/${{ github.ref_name }}/climate-win-x64.zip'
          `$checksum64 = '$hash'
          `$packageArgs = @{
              packageName    = `$packageName
              unzipLocation  = `$toolsDir
              url64bit       = `$url64
              checksum64     = `$checksum64
              checksumType64 = 'sha256'
          }
          Install-ChocolateyZipPackage @packageArgs
          `$climatePath = Join-Path `$toolsDir 'climate.exe'
          Install-BinFile -Name 'climate' -Path `$climatePath
          "@ | Set-Content "choco/tools/chocolateyinstall.ps1" -Encoding UTF8

          # Create uninstall script
          @"
          `$ErrorActionPreference = 'Stop'
          Uninstall-BinFile -Name 'climate'
          "@ | Set-Content "choco/tools/chocolateyuninstall.ps1" -Encoding UTF8

      - name: Pack and push to Chocolatey
        shell: pwsh
        run: |
          cd choco
          choco pack climate.nuspec
          $nupkg = Get-ChildItem "*.nupkg" | Select-Object -First 1
          choco push $nupkg.Name --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCOLATEY_API_KEY }}

  nuget:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Pack NuGet
        run: dotnet pack CLImate.App -c Release -o nupkg

      - name: Push to NuGet
        run: dotnet nuget push nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nupkg/*.nupkg
